# PolyLens 项目完整说明书

> 本文档面向非技术背景人员，用通俗易懂的语言讲解项目原理、代码架构和运行流程。

---

## 目录

1. [项目是什么](#1-项目是什么)
2. [项目解决什么问题](#2-项目解决什么问题)
3. [核心功能详解](#3-核心功能详解)
4. [技术架构通俗解读](#4-技术架构通俗解读)
5. [代码结构说明](#5-代码结构说明)
6. [数据流转过程](#6-数据流转过程)
7. [运行部署教程](#7-运行部署教程)
8. [关键指标计算说明](#8-关键指标计算说明)
9. [常见问题解答](#9-常见问题解答)

---

## 1. 项目是什么

### 一句话介绍
**PolyLens** 是一个 Polymarket（预测市场平台）的数据分析工具，帮助交易者看懂市场、追踪大户、做出更明智的交易决策。

### 通俗比喻
想象 Polymarket 是一个股票交易所：
- **Polymarket** = 交易所本身（提供买卖的地方）
- **PolyLens** = 股票分析软件（帮你分析行情、看K线、追踪大户动向）

就像炒股需要同花顺、东方财富这类软件来看行情一样，玩 Polymarket 也需要 PolyLens 这样的工具来辅助分析。

### 什么是 Polymarket？
Polymarket 是全球最大的去中心化预测市场，用户可以用真金白银对未来事件下注，比如：
- "特朗普会赢得2024大选吗？"
- "比特币年底能到10万美元吗？"

所有交易数据都记录在区块链上（Polygon链），完全公开透明。

---

## 2. 项目解决什么问题

### 痛点分析

| 现状问题 | PolyLens 解决方案 |
|---------|------------------|
| 区块链数据是天书般的代码 | 转化为直观的图表和数字 |
| 不知道大户在买什么 | 实时追踪鲸鱼（大户）交易 |
| 看不到历史价格走势 | 提供专业K线图 |
| 不知道谁是高手 | 交易员排行榜和画像 |
| 信息碎片化 | 一站式数据仪表盘 |

### 核心价值
**将"透明但看不懂"的链上数据，转化为"一目了然"的交易情报。**

---

## 3. 核心功能详解

### 3.1 市场雷达（首页）
**功能**：展示所有热门预测市场，支持分类筛选和搜索。

**包含信息**：
- 市场问题（如"俄乌会在2026年停火吗？"）
- 当前价格（YES/NO的概率）
- 24小时交易量
- 交易次数

**使用场景**：快速浏览市场、发现热点话题、寻找交易机会。

### 3.2 K线图表
**功能**：显示某个市场的历史价格走势。

**什么是K线？**
K线是金融市场最常用的图表类型，每根"蜡烛"代表一段时间内的价格变化：
- 绿色蜡烛 = 价格上涨
- 红色蜡烛 = 价格下跌
- 蜡烛的长度 = 波动幅度

**支持的时间周期**：1分钟、5分钟、15分钟、1小时、4小时、1天

### 3.3 市场指标
**功能**：用数字量化市场情绪。

**核心指标解释**：

| 指标 | 含义 | 作用 |
|-----|------|-----|
| VWAP | 成交量加权平均价 | 判断当前价格是偏高还是偏低 |
| 买入压力 | 买入金额占比 | 看多的人多不多 |
| 卖出压力 | 卖出金额占比 | 看空的人多不多 |
| 净流入 | 买入-卖出 | 资金是流入还是流出 |
| 交易者数量 | 参与的独立地址数 | 市场活跃度 |

### 3.4 鲸鱼追踪
**功能**：实时监控大额交易（鲸鱼=资金量大的交易者）。

**为什么要追踪鲸鱼？**
- 鲸鱼通常有更多信息或更强的分析能力
- 他们的大额买卖会影响市场走势
- 跟踪"聪明钱"的动向可以辅助决策

**鲸鱼等级**：🐋 Whale → 🦈 Shark → 🐬 Dolphin → 🐟 Fish

等级由单笔交易金额或单市场累计交易量决定，详细阈值见 [8.4 鲸鱼等级计算说明](#84-鲸鱼等级whale-level)。

### 3.5 交易员画像
**功能**：查看任意交易员的详细档案。

**包含信息**：
- 历史盈亏曲线（PnL Chart）
- 总盈亏金额
- 交易偏好（喜欢交易哪类市场）
- 最近交易记录
- 当前持仓

**使用场景**：
- 验证某个"大神"是否真的厉害
- 分析高手的交易策略
- 决定是否跟单某个交易员

### 3.6 排行榜
**功能**：按盈利或交易量排名的交易员榜单。

**排名维度**：
- PnL排行（谁赚得最多）
- 交易量排行（谁交易最活跃）

### 3.7 市场洞察（Insights）
**功能**：宏观市场分析页面。

**包含模块**：
- 市场情绪指数
- 热门市场榜单
- Smart Money（聪明钱）动向
- 异常交易监测

---

## 4. 技术架构通俗解读

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      用户浏览器                              │
│                   （React 前端界面）                         │
└─────────────────────────────────────────────────────────────┘
                              ↑↓ 请求数据
┌─────────────────────────────────────────────────────────────┐
│                      后端服务器                              │
│                 （FastAPI Python服务）                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  API接口    │  │  数据处理   │  │  定时任务   │         │
│  │  (routes)   │  │  (core)     │  │  (scheduler)│         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              ↑↓ 读写数据
┌─────────────────────────────────────────────────────────────┐
│                      数据库 (SQLite)                         │
│            存储：市场信息、交易记录、K线数据等               │
└─────────────────────────────────────────────────────────────┘
                              ↑ 获取原始数据
┌──────────────────────┬──────────────────────────────────────┐
│   Polygon 区块链     │        Gamma/Polymarket API          │
│   （交易记录来源）   │        （市场元数据来源）            │
└──────────────────────┴──────────────────────────────────────┘
```

### 通俗解释各层作用

#### 第1层：前端界面（用户能看到的部分）
- **技术**：React + TypeScript
- **作用**：展示数据、响应用户操作
- **比喻**：餐厅的"前厅"，顾客在这里点餐、用餐

#### 第2层：后端服务（处理逻辑的部分）
- **技术**：Python + FastAPI
- **作用**：接收请求、处理数据、返回结果
- **比喻**：餐厅的"后厨"，接到订单后准备菜品

#### 第3层：数据库（存储数据的部分）
- **技术**：SQLite
- **作用**：持久化存储所有数据
- **比喻**：餐厅的"仓库"，存放所有食材

#### 第4层：外部数据源（原始数据来源）
- **Polygon区块链**：所有交易的原始记录
- **Gamma API**：市场的基本信息（问题、图片、分类等）
- **比喻**：餐厅的"供应商"，提供原材料

---

## 5. 代码结构说明

### 项目文件夹总览

```
PolyLens/
├── src/                    # 后端代码（Python）
├── web/                    # 前端代码（React）
├── data/                   # 运行时数据
├── screenshots/            # 项目截图
├── requirements.txt        # Python依赖清单
├── README.md              # 项目介绍
└── .env                   # 环境配置（密钥等）
```

### 后端代码结构 (`src/`)

```
src/
├── main.py                 # 程序入口（启动服务的地方）
├── config.py               # 配置文件（读取环境变量）
│
├── api/                    # API接口层
│   ├── main.py            # FastAPI应用主文件
│   ├── routes/            # 各功能的接口
│   │   ├── markets.py     # 市场相关接口
│   │   ├── traders.py     # 交易员相关接口
│   │   ├── klines.py      # K线数据接口
│   │   ├── whales.py      # 鲸鱼交易接口
│   │   ├── metrics.py     # 市场指标接口
│   │   └── holders.py     # 持仓者接口
│   └── websocket/         # 实时推送功能
│       └── manager.py     # WebSocket管理
│
├── core/                   # 核心业务逻辑
│   ├── indexer.py         # 区块链数据索引器
│   ├── discovery.py       # 市场发现模块
│   ├── klines.py          # K线生成算法
│   ├── metrics.py         # 指标计算逻辑
│   ├── whale_detector.py  # 鲸鱼检测逻辑
│   ├── ctf_utils.py       # 密码学验证工具
│   └── db/                # 数据库相关
│       ├── schema.py      # 数据表结构定义
│       └── store.py       # 数据存取操作
│
└── scheduler/              # 定时任务
    └── jobs.py            # 后台同步任务
```

#### 核心模块功能说明

| 模块 | 文件 | 功能说明 |
|-----|------|---------|
| 索引器 | `indexer.py` | 从区块链抓取原始交易数据 |
| 发现器 | `discovery.py` | 从API获取市场基本信息 |
| K线生成 | `klines.py` | 将交易数据聚合成K线 |
| 指标计算 | `metrics.py` | 计算VWAP、买卖压力等 |
| 鲸鱼检测 | `whale_detector.py` | 识别大额交易 |
| 密码学验证 | `ctf_utils.py` | 验证Token ID真实性 |

### 前端代码结构 (`web/src/`)

```
web/src/
├── main.tsx               # 前端入口文件
├── App.tsx                # 应用主组件（路由配置）
├── index.css              # 全局样式
│
├── pages/                 # 页面组件（每个URL对应一个）
│   ├── Home.tsx          # 首页（市场列表）
│   ├── MarketDetail.tsx  # 市场详情页
│   ├── TraderProfile.tsx # 交易员画像页
│   ├── TraderLeaderboard.tsx # 排行榜页
│   └── Insights.tsx      # 市场洞察页
│
├── components/            # 可复用组件
│   ├── chart/            # 图表组件
│   │   └── KlineChart.tsx
│   ├── market/           # 市场相关组件
│   │   ├── MarketCard.tsx
│   │   ├── MarketFilter.tsx
│   │   └── PriceBar.tsx
│   ├── trader/           # 交易员相关组件
│   │   ├── TraderLevelBadge.tsx
│   │   └── TraderPnLChart.tsx
│   ├── whale/            # 鲸鱼相关组件
│   │   └── WhaleTable.tsx
│   ├── common/           # 通用组件
│   │   ├── Badge.tsx
│   │   └── Spinner.tsx
│   └── layout/           # 布局组件
│       ├── Navbar.tsx
│       └── Layout.tsx
│
├── hooks/                 # 数据获取钩子
│   ├── useMarkets.ts     # 获取市场数据
│   ├── useTrader.ts      # 获取交易员数据
│   ├── useKlines.ts      # 获取K线数据
│   └── useWhales.ts      # 获取鲸鱼数据
│
├── contexts/              # 全局状态
│   └── ThemeContext.tsx  # 主题切换（日/夜间模式）
│
├── api/                   # API调用封装
│   └── client.ts         # HTTP请求客户端
│
├── types/                 # TypeScript类型定义
│   └── index.ts
│
└── utils/                 # 工具函数
    └── format.ts         # 格式化函数（数字、日期等）
```

---

## 6. 数据流转过程

### 场景1：用户查看市场列表

```
用户打开首页
    ↓
前端发起请求 GET /api/markets
    ↓
后端收到请求
    ↓
从数据库查询市场数据
    ↓
返回JSON数据给前端
    ↓
前端渲染市场卡片列表
    ↓
用户看到页面
```

### 场景2：后台数据同步

```
定时任务触发（每10秒）
    ↓
索引器连接Polygon区块链
    ↓
获取最新交易事件
    ↓
解析交易数据（买/卖、金额、地址等）
    ↓
存入数据库
    ↓
如果是大额交易 → 通过WebSocket推送给前端
```

**为什么这里使用 WebSocket**

WebSocket 就像“打开着的电话线”。一旦连接建立，服务器可以在有新消息时立刻通知你，而不需要你反复刷新页面。

- **更及时**：大额交易发生后可以秒级推送，不会因为刷新慢而错过提示。
- **更省资源**：不用频繁“问服务器有没有新消息”，减少重复请求。
- **体验更顺畅**：前端一直保持连接，提示可以持续、稳定地出现。

### 场景3：K线图生成

```
原始交易数据（时间、价格、数量）
    ↓
按时间周期分组（如5分钟一组）
    ↓
计算每组的：开盘价、最高价、最低价、收盘价、成交量
    ↓
生成K线数据
    ↓
前端用图表库渲染成蜡烛图
```

---

## 7. 运行部署教程

### 7.1 环境要求

| 项目 | 要求 |
|-----|------|
| 操作系统 | Windows / macOS / Linux 均可 |
| Python | 3.10 或更高版本 |
| Node.js | 18 或更高版本 |
| 网络 | 需要能访问外网 |

### 7.2 安装步骤（详细版）

#### 第一步：获取代码
```bash
# 如果是压缩包，解压到任意目录
# 如果是Git仓库：
git clone <仓库地址>
cd PolyLens
```

#### 第二步：配置环境变量
```bash
# 复制配置模板
cp .env.example .env

# 用文本编辑器打开 .env 文件，填入必要的API密钥
# 主要需要配置：
# - POLYGON_RPC_URL：区块链节点地址
# - 其他API密钥（如有）
```

#### 第三步：安装后端依赖
```bash
# 安装Python包
pip install -r requirements.txt
```

#### 第四步：初始化数据
```bash
# 索引最近的区块链数据（首次运行必须执行）
python -m src.main index --latest 1000

# 这一步会：
# 1. 创建数据库文件
# 2. 从区块链获取最近1000个区块的交易数据
# 3. 可能需要几分钟时间
```

#### 第五步：启动后端服务
```bash
python -m src.main serve --port 8000

# 成功后会显示：
# INFO:     Uvicorn running on http://0.0.0.0:8000
```

#### 第六步：启动前端服务（新开一个终端窗口）
```bash
cd web
npm install          # 安装前端依赖（首次运行）
npm run dev          # 启动开发服务器

# 成功后会显示：
# Local: http://localhost:5173/
```

### 7.3 验证运行状态

| 检查项 | 访问地址 | 正常表现 |
|-------|---------|---------|
| 后端API文档 | http://localhost:8000/docs | 显示Swagger接口文档 |
| 前端界面 | http://localhost:5173 | 显示市场列表页面 |

### 7.4 常用命令速查

| 用途 | 命令 |
|-----|------|
| 启动后端 | `python -m src.main serve --port 8000` |
| 启动前端 | `cd web && npm run dev` |
| 索引数据 | `python -m src.main index --latest 1000` |
| 构建生产版前端 | `cd web && npm run build` |
| 代码检查 | `cd web && npm run lint` |

---

## 8. 关键指标计算说明

本节解释 PolyLens 中各项核心指标的计算方式，帮助用户正确理解数据含义。

### 8.1 胜率（Win Rate）

**计算方式：价值加权胜率**

胜率并非简单的"赢的市场数 ÷ 总市场数"，而是基于**盈亏金额**计算：

```
胜率 = 总盈利金额 ÷ (总盈利金额 + 总亏损金额) × 100%
```

**为什么采用价值加权？**
- 更能反映实际投资回报能力
- 避免"小亏大赚"的高手被低估
- 与资金管理能力挂钩

**示例说明**

| 交易者 | 盈利市场 | 亏损市场 | 简单胜率 | 价值加权胜率 |
|-------|---------|---------|---------|-------------|
| A | 赚$100（1个市场） | 亏$10（9个市场） | 10% | 91% |
| B | 赚$1000（9个市场） | 亏$100（1个市场） | 90% | 91% |

交易者A虽然只赢了1个市场，但赚的钱远超亏损，价值加权胜率会很高。这意味着：

> ⚠️ **高胜率不代表赢的次数多，而是代表赚的钱占比高。**

如需查看具体的赢/输市场数量，可以在交易员画像页面查看"已关闭持仓"列表。

### 8.2 总盈亏（PnL）

**数据来源**：Polymarket 官方排行榜 API

**说明**：
- 包含已实现盈亏（已关闭的仓位）
- 不包含未实现盈亏（当前持有的仓位）
- 数值可能与"持仓"页面的累计不完全一致，因为来源不同

### 8.3 最大盈利（Biggest Win）

**计算方式**：在所有已关闭仓位中，单笔 realizedPnl 的最大值。

### 8.4 鲸鱼等级（Whale Level）

**判定标准**：基于交易者的**单笔最大交易金额**和**单市场累计交易量**：

| 等级 | 徽章 | 单笔交易门槛 | 或 单市场累计门槛 |
|-----|------|-------------|------------------|
| Whale | 🐋 | ≥$100,000 | ≥$500,000 |
| Shark | 🦈 | ≥$10,000 | ≥$50,000 |
| Dolphin | 🐬 | ≥$1,000 | ≥$5,000 |
| Fish | 🐟 | <$1,000 | <$5,000 |

### 8.5 VWAP（成交量加权平均价）

**计算公式**：
```
VWAP = Σ(价格 × 成交量) ÷ Σ(成交量)
```

**用途**：判断当前价格相对于平均成本是高还是低。价格高于 VWAP 表示近期买家整体处于盈利状态。

### 8.6 买卖压力比

**计算方式**：
```
买入压力 = 买入金额 ÷ 总成交金额 × 100%
卖出压力 = 卖出金额 ÷ 总成交金额 × 100%
```

**说明**：买入压力高于50%表示市场整体偏多，反之偏空。

---

## 9. 常见问题解答

### Q1: 启动后端报错 "ModuleNotFoundError"
**原因**：Python依赖没有安装完整

**解决**：重新执行 `pip install -r requirements.txt`

### Q2: 前端页面显示空白或报错
**原因**：后端服务没有启动

**解决**：确保后端在运行，检查 http://localhost:8000/docs 是否能访问

### Q3: 数据库文件在哪里？
**位置**：初始化数据后data目录下会生成 `dashboard.db` 文件

**说明**：这是SQLite数据库，可以用任何SQLite工具打开查看，或者在终端命令行交互查看

### Q4: 如何更新数据？
**方法**：后端启动后会自动每10秒同步一次最新数据

**手动同步**：重新运行 `python -m src.main index --latest 100`

### Q5: 如何切换日间/夜间模式？
**方法**：点击页面右上角导航栏的主题切换按钮（太阳/月亮图标）。默认跟随系统模式

### Q6: 如何部署到服务器？
**后端**：
```bash
# 使用生产级服务器
pip install gunicorn
gunicorn -w 4 -k uvicorn.workers.UvicornWorker src.api.main:app
```

**前端**：
```bash
cd web
npm run build
# 将 dist/ 文件夹部署到任意静态文件服务器（Nginx、Vercel等）
```

### Q7: 数据来源可靠吗？
**回答**：
- 交易数据直接来自Polygon区块链，不可篡改
- 项目内置ECC密码学验证，确保数据真实性
- 市场元数据来自官方Gamma API

---

## 附录：技术术语表

| 术语 | 解释 |
|-----|------|
| API | 应用程序接口，程序之间通信的约定 |
| 区块链 | 去中心化的分布式账本，数据公开透明 |
| K线 | 金融图表类型，显示价格走势 |
| WebSocket | 实时双向通信技术 |
| Token | 代币，区块链上的数字资产 |
| VWAP | 成交量加权平均价格 |
| PnL | Profit and Loss，盈亏 |
| 鲸鱼 | 持有大量资金的交易者 |
| SQLite | 轻量级文件数据库 |
| React | 前端界面框架 |
| FastAPI | Python后端框架 |

---

*文档版本：1.0*
*最后更新：2026年2月*
